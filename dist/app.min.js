_.mixin({capitalize:function(e){var i=e.split("-");return i.reduce(function(e,i){return e+i[0].toUpperCase()+i.slice(1)})},hyphen:function(e){return e.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}});var app={};!function(e){e.BookModel=Backbone.Model.extend({defaults:{book:"",author:"",publishYear:"",publishHouse:""},initialize:function(){},validate:function(e){var i={};return e.book||(i.book="Введите название книги."),e.author||(i.author="Введите автора."),e.publishYear||(i.publishYear="Введите год издания."),e.publishHouse||(i.publishHouse="Введите издательство."),_.isEmpty(i)?!1:i}})}(app),function(e){e.LibraryCollection=Backbone.Collection.extend({model:e.BookModel,localStorage:new Backbone.LocalStorage("Library")})}(app),function(e){e.BaseView=Backbone.View.extend({showErrors:function(e,i){_.each(i,function(i,t){this.$("#"+_.hyphen(t)+"-"+e.cid).siblings(".book-form__error").html(i)},this)},disableElement:function(e,i){this.$(e).prop("disabled",i)},close:function(){this.remove(),this.unbind()}})}(app),function(e){e.BookView=e.BaseView.extend({tagName:"li",className:"library-list__item",template:_.template($("#single-book-template").html()),events:{"click .delete-book":"deleteBook","click .edit-book":"editBook"},initialize:function(){this.listenTo(this.model,"change",this.render).listenTo(this,"disable-edit",this.disableElement)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},deleteBook:function(){confirm("Вы действительно хотите удалить книгу?")&&(this.editView&&this.editView.close(),this.close(),this.model.destroy())},editBook:function(){this.editView=new e.EditView({model:this.model}),this.listenTo(this.editView,"disable-edit",this.disableElement),this.$el.append(this.editView.render().el),this.trigger("disable-edit",".edit-book",!0)}})}(app),function(e){e.EditView=e.BaseView.extend({tagName:"form",className:"book-form",id:function(){return"edit-form-"+this.model.cid},template:_.template($("#edit-form-template").html()),events:{"click .submit-edited-book":"submitEditedBook","click .cancel-edit":"cancelEdit"},render:function(){return this.$el.html(this.template(this.model)),_.each(this.model.toJSON(),this.fillEditFields,this),this},fillEditFields:function(e,i){this.$("#"+_.hyphen(i+"-"+this.model.cid)).val(e)},submitEditedBook:function(){function e(e){t[_.capitalize(e.id.replace("-"+o,""))]=encodeURIComponent(e.value)}var i=this.$("input"),t={},o=this.model.cid;Backbone.trigger("clear-errors"),this.listenTo(this.model,"invalid",this.showErrors),_.each(i,e,this),this.model.save(t,{success:function(){this.cancelEdit()}.bind(this)})},cancelEdit:function(){this.trigger("disable-edit",".edit-book",!1),this.close()}})}(app),function(e){e.AppView=e.BaseView.extend({el:"body",initialize:function(){this.collection=new e.LibraryCollection,this.listenTo(this.collection,"reset",this.addAll).listenTo(Backbone,"clear-errors",this.clearErrors),this.collection.fetch({reset:!0})},events:{"click #submit-book":"submit"},clearErrors:function(){this.$(".book-form__error").html("")},submit:function(){var i=this.$("#book-form input"),t={},o={};if(Backbone.trigger("clear-errors"),function(){function e(e){t[_.capitalize(e.id)]=encodeURIComponent(e.value)}return _.each(i,e,this),t.book||(o.book="Введите название книги."),t.author||(o.author="Введите автора."),t.publishYear||(o.publishYear="Введите год издания."),t.publishHouse||(o.publishHouse="Введите издательство."),o}(),_.isEmpty(o)){var n=new e.BookModel;n.set(t),i.val(""),this.collection.create(n);var s=new e.BookView({model:n});this.$("#library-list").append(s.render().el)}else this.showErrors(o)},showErrors:function(e){_.each(e,function(e,i){this.$("#"+_.hyphen(i)).siblings(".book-form__error").html(e)},this)},addAll:function(){function i(i){var o=new e.BookView({model:i});t.append(o.render().el)}var t=$(document.createDocumentFragment());this.collection.each(i,this),this.$("#library-list").append(t)}})}(app),$(function(){new app.AppView});